<!DOCTYPE html>
<html lang="en">
<head><script>window.huggingface={variables:{"SPACE_CREATOR_USER_ID":"682072962ed9357111b56ac1"}};</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATRIX GALLERY | Player Creations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            background-color: #0a0a0a;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        
        .minecraft-bg {
            background-image: url('https://images.unsplash.com/photo-1585771724684-38270d0d4a5f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        .section {
            min-height: 100vh;
            padding: 6rem 2rem;
            position: relative;
        }
        
        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(10,10,10,0.8) 0%, rgba(10,10,10,0.95) 100%);
            z-index: -1;
        }
        
        .glow-text {
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.7);
        }
        
        .glow-box {
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.3);
            transition: all 0.3s ease;
        }
        
        .glow-box:hover {
            box-shadow: 0 0 30px rgba(74, 222, 128, 0.5);
        }
        
        .nav-link {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -2px;
            left: 0;
            background-color: #4ade80;
            transition: width 0.3s ease;
        }
        
        .nav-link:hover::after {
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(74, 222, 128, 0.3);
        }
        
        .gallery-card {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(74, 222, 128, 0.2);
            transition: all 0.3s ease;
        }
        
        .gallery-card:hover {
            transform: translateY(-5px);
            border-color: rgba(74, 222, 128, 0.5);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        
        .fade-in {
            animation: fadeIn 1s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .scroll-down {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: #4ade80;
            font-size: 2rem;
            animation: bounce 2s infinite;
            cursor: pointer;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0) translateX(-50%); }
            40% { transform: translateY(-20px) translateX(-50%); }
            60% { transform: translateY(-10px) translateX(-50%); }
        }
        
        .grid-item {
            transition: all 0.3s ease;
        }
        
        .grid-item:hover {
            transform: scale(1.02);
        }
        
        .upload-area {
            border: 2px dashed rgba(74, 222, 128, 0.3);
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: rgba(74, 222, 128, 0.7);
            background-color: rgba(74, 222, 128, 0.05);
        }
        
        .upload-area.dragover {
            border-color: rgba(74, 222, 128, 0.9);
            background-color: rgba(74, 222, 128, 0.1);
        }
        
        .comment-section {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #4ade80 #1a1a1a;
        }
        
        .comment-section::-webkit-scrollbar {
            width: 8px;
        }
        
        .comment-section::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        .comment-section::-webkit-scrollbar-thumb {
            background-color: #4ade80;
            border-radius: 20px;
        }
        
        .comment-item {
            border-left: 2px solid #4ade80;
            transition: all 0.3s ease;
        }
        
        .comment-item:hover {
            background-color: rgba(74, 222, 128, 0.05);
        }
        
        .reply-item {
            border-left: 2px solid #3b82f6;
            margin-left: 20px;
        }
        
        .like-btn.liked {
            color: #ef4444;
        }
        
        @media (max-width: 768px) {
            .section {
                padding: 5rem 1rem;
            }
            
            .text-6xl {
                font-size: 3rem;
            }
            
            .text-4xl {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body class="text-gray-200">
    <!-- Header -->
    <header class="fixed w-full bg-black bg-opacity-90 z-50 border-b border-gray-800">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="text-2xl font-bold text-green-500 glow-text">
                    MATRIX<span class="text-white">GALLERY</span>
                </div>
                
                <nav class="hidden md:flex space-x-8">
                    <a href="index.html" class="nav-link text-sm uppercase tracking-wider hover:text-green-400">Home</a>
                    <a href="#home" class="nav-link text-sm uppercase tracking-wider hover:text-green-400">Gallery</a>
                    <a href="#upload" class="nav-link text-sm uppercase tracking-wider hover:text-green-400">Upload</a>
                    <a href="feedback.html" class="nav-link text-sm uppercase tracking-wider hover:text-green-400">Feedback</a>
                </nav>
                
                <div class="md:hidden">
                    <button id="menu-toggle" class="text-gray-300 hover:text-green-400 focus:outline-none">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile menu -->
            <div id="mobile-menu" class="hidden md:hidden mt-4 pb-2">
                <div class="flex flex-col space-y-3">
                    <a href="index.html" class="nav-link text-sm uppercase tracking-wider hover:text-green-400">Home</a>
                    <a href="#home" class="nav-link text-sm uppercase tracking-wider hover:text-green-400">Gallery</a>
                    <a href="#upload" class="nav-link text-sm uppercase tracking-wider hover:text-green-400">Upload</a>
                    <a href="feedback.html" class="nav-link text-sm uppercase tracking-wider hover:text-green-400">Feedback</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section id="home" class="section minecraft-bg flex items-center justify-center">
        <div class="container mx-auto px-4 text-center">
            <div class="floating">
                <h1 class="text-4xl md:text-6xl font-bold mb-6 text-white glow-text">
                    <span class="text-green-500">MATRIX</span> GALLERY
                </h1>
            </div>
            <p class="text-xl md:text-2xl mb-8 text-gray-300 max-w-3xl mx-auto fade-in">
                Showcase your Minecraft creations with the community. Upload your builds, bases, and adventures!
            </p>
            
            <div class="scroll-down" onclick="scrollToSection('upload')">
                <i class="fas fa-chevron-down"></i>
            </div>
        </div>
    </section>

    <!-- Upload Section -->
    <section id="upload" class="section bg-gradient-to-b from-black to-gray-900">
        <div class="container mx-auto px-4">
            <div class="text-center mb-16">
                <h2 class="text-3xl md:text-4xl font-bold mb-4 text-white">
                    UPLOAD <span class="text-green-500">CREATIONS</span>
                </h2>
                <div class="w-24 h-1 bg-green-500 mx-auto"></div>
            </div>
            
            <div class="max-w-4xl mx-auto">
                <div class="gallery-card p-8 rounded-lg">
                    <form id="upload-form">
                        <!-- User Information -->
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold mb-4 text-green-400">YOUR INFORMATION</h3>
                            <div>
                                <label for="gallery-username" class="block text-sm font-medium mb-2">Minecraft Username *</label>
                                <input type="text" id="gallery-username", name="username" required 
                                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                        
                        <!-- Image Upload -->
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold mb-4 text-green-400">YOUR CREATION *</h3>
                            <div id="upload-area" class="upload-area rounded-lg p-8 text-center cursor-pointer">
                                <i class="fas fa-cloud-upload-alt text-5xl text-green-500 mb-4"></i>
                                <p class="text-lg font-medium mb-2">Drag & Drop your image here</p>
                                <p class="text-sm text-gray-400 mb-4">or click to browse files</p>
                                <input type="file" id="image-upload" name="image" accept="image/*" class="hidden" required>
                                <button type="button" id="browse-btn" class="btn-primary px-6 py-2 rounded-lg text-sm font-semibold text-white">
                                    Select Image
                                </button>
                            </div>
                            <div id="file-info" class="mt-4 hidden">
                                <p class="text-sm text-gray-400"><span id="file-name" class="text-green-400"></span> (<span id="file-size"></span>)</p>
                            </div>
                            <div id="preview-container" class="mt-4 hidden">
                                <img id="image-preview" class="max-w-full max-h-64 rounded-lg mx-auto" src="" alt="Preview">
                            </div>
                        </div>
                        
                        <!-- Image Details -->
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold mb-4 text-green-400">CREATION DETAILS</h3>
                            <div>
                                <label for="image-title" class="block text-sm font-medium mb-2">Title (Optional)</label>
                                <input type="text" id="image-title" name="title" 
                                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="My Awesome Base">
                            </div>
                            <div class="mt-4">
                                <label for="image-description" class="block text-sm font-medium mb-2">Description (Optional)</label>
                                <textarea id="image-description" name="description" rows="3"
                                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Tell us about your creation..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="text-center mt-8">
                            <button type="submit" id="upload-btn" class="btn-primary px-8 py-4 rounded-lg text-lg font-semibold text-white pulse">
                                <i class="fas fa-upload mr-2"></i> UPLOAD CREATION
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Gallery Section -->
    <section id="gallery" class="section bg-gradient-to-b from-gray-900 to-black">
        <div class="container mx-auto px-4">
            <div class="text-center mb-16">
                <h2 class="text-3xl md:text-4xl font-bold mb-4 text-white">
                    PLAYER <span class="text-green-500">CREATIONS</span>
                </h2>
                <div class="w-24 h-1 bg-green-500 mx-auto"></div>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" id="gallery-grid">
                <!-- Images will be loaded here -->
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-green-500"></i>
                    <p class="mt-4">Loading creations...</p>
                </div>
            </div>
            
            <div class="text-center mt-12 hidden" id="load-more-container">
                <button id="load-more-btn" class="btn-primary px-6 py-3 rounded-lg text-sm font-semibold text-white">
                    <i class="fas fa-plus mr-2"></i> LOAD MORE
                </button>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-black py-12 border-t border-gray-800">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-bold text-green-500 mb-4">MATRIX GALLERY</h3>
                    <p class="text-gray-500 text-sm">
                        Showcasing the best Minecraft creations from our community.
                    </p>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold mb-4 text-gray-300">QUICK LINKS</h4>
                    <ul class="space-y-2">
                        <li><a href="index.html" class="text-gray-500 hover:text-green-400 transition text-sm">Home</a></li>
                        <li><a href="#home" class="text-gray-500 hover:text-green-400 transition text-sm">Gallery</a></li>
                        <li><a href="#upload" class="text-gray-500 hover:text-green-400 transition text-sm">Upload</a></li>
                        <li><a href="feedback.html" class="text-gray-500 hover:text-green-400 transition text-sm">Feedback</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold mb-4 text-gray-300">CONNECT</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-500 hover:text-green-400 transition text-sm"><i class="fab fa-discord mr-2"></i> Discord</a></li>
                        <li><a href="#" class="text-gray-500 hover:text-green-400 transition text-sm"><i class="fab fa-youtube mr-2"></i> YouTube</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-gray-800 mt-12 pt-8 text-center">
                <p class="text-gray-600 text-sm">
                    &copy; 2023 MATRIX GALLERY. All rights reserved. Minecraft is a trademark of Mojang Studios.
                </p>
            </div>
        </div>
    </footer>

    <!-- Image Modal -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden items-center justify-center p-4">
        <div class="relative max-w-4xl w-full">
            <button id="close-modal" class="absolute -top-10 right-0 text-white text-2xl hover:text-green-400">
                <i class="fas fa-times"></i>
            </button>
            <div class="bg-gray-900 rounded-lg overflow-hidden">
                <img id="modal-image" class="w-full max-h-[70vh] object-contain" src="" alt="Full size image">
                <div class="p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 id="modal-title" class="text-xl font-bold text-green-400"></h3>
                            <p id="modal-username" class="text-gray-400 text-sm mt-1"></p>
                            <p id="modal-description" class="text-gray-300 mt-2"></p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="like-btn" class="like-btn flex items-center space-x-1 text-gray-400 hover:text-red-500 transition">
                                <i class="far fa-heart text-xl"></i>
                                <span id="like-count">0</span>
                            </button>
                            <button id="comment-btn" class="flex items-center space-x-1 text-gray-400 hover:text-blue-400 transition">
                                <i class="far fa-comment text-xl"></i>
                                <span id="comment-count">0</span>
                            </button>
                        </div>
                    </div>
                    <p id="modal-date" class="text-gray-500 text-xs mt-4"></p>
                    
                    <!-- Comment Section (Hidden by default) -->
                    <div id="comment-section" class="mt-6 hidden">
                        <div class="comment-section bg-gray-800 rounded-lg p-4 mb-4">
                            <!-- Comments will be loaded here -->
                            <p class="text-center text-gray-500 py-4">No comments yet. Be the first to comment!</p>
                        </div>
                        
                        <!-- Comment Form -->
                        <div id="comment-form-container" class="bg-gray-800 rounded-lg p-4">
                            <h4 class="text-sm font-semibold mb-2 text-green-400">ADD A COMMENT</h4>
                            <form id="comment-form">
                                <div class="mb-3">
                                    <input type="text" id="comment-username" placeholder="Your Minecraft username" required
                                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500">
                                </div>
                                <div class="mb-3">
                                    <textarea id="comment-text" rows="2" placeholder="Write your comment..." required
                                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500"></textarea>
                                </div>
                                <input type="hidden" id="parent-comment-id" value="">
                                <button type="submit" class="btn-primary px-4 py-2 rounded text-sm font-semibold">
                                    <i class="fas fa-paper-plane mr-1"></i> POST COMMENT
                                </button>
                                <button type="button" id="cancel-reply" class="ml-2 px-3 py-2 bg-gray-700 rounded text-sm font-semibold hidden">
                                    Cancel Reply
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Username Modal for Likes -->
    <div id="username-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-900 rounded-lg p-6 max-w-md w-full">
            <h3 class="text-lg font-bold text-green-400 mb-4">Enter Your Minecraft Username</h3>
            <p class="text-sm text-gray-400 mb-4">We need your Minecraft username to record your like.</p>
            <input type="text" id="like-username" placeholder="Your Minecraft username" required
                class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-green-500">
            <div class="flex justify-end space-x-3">
                <button id="cancel-like" class="px-4 py-2 bg-gray-700 rounded-lg text-sm font-semibold">
                    Cancel
                </button>
                <button id="confirm-like" class="btn-primary px-4 py-2 rounded-lg text-sm font-semibold">
                    Submit Like
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA2-4SckTZtI4FhV0BMB2cj1wIrV2VtZOw",
            authDomain: "matrix-54eb3.firebaseapp.com",
            projectId: "matrix-54eb3",
            storageBucket: "matrix-54eb3.firebasestorage.app",
            messagingSenderId: "719494599002",
            appId: "1:719494599002:web:a7f2e705680d8cb7fda363",
            measurementId: "G-7269E57HH8"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ImgBB API Key
        const IMGBB_API_KEY = '052c9ca674652dfacbfe247334f472f6';
        
        // Current image ID for likes and comments
        let currentImageId = null;
        let currentUsername = null;
        let likedImages = JSON.parse(localStorage.getItem('likedImages') || '{}');
        
        // Mobile menu toggle
        document.getElementById('menu-toggle').addEventListener('click', function() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });

        // Smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                
                const targetId = this.getAttribute('href');
                if (targetId.startsWith('#')) {
                    const targetElement = document.querySelector(targetId);
                    
                    if (targetElement) {
                        window.scrollTo({
                            top: targetElement.offsetTop - 80,
                            behavior: 'smooth'
                        });
                        
                        // Close mobile menu if open
                        const mobileMenu = document.getElementById('mobile-menu');
                        if (!mobileMenu.classList.contains('hidden')) {
                            mobileMenu.classList.add('hidden');
                        }
                    }
                }
            });
        });

        // Scroll to section function
        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                window.scrollTo({
                    top: section.offsetTop - 80,
                    behavior: 'smooth'
                });
            }
        }
        
        // Upload area functionality
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('image-upload');
        const browseBtn = document.getElementById('browse-btn');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        const previewContainer = document.getElementById('preview-container');
        const imagePreview = document.getElementById('image-preview');
        
        // Handle drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            uploadArea.classList.add('dragover');
        }
        
        function unhighlight() {
            uploadArea.classList.remove('dragover');
        }
        
        // Handle dropped files
        uploadArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                fileInput.files = files;
                handleFiles(files);
            }
        }
        
        // Browse button click
        browseBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        // File input change
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                handleFiles(fileInput.files);
            }
        });
        
        // Handle selected files
        function handleFiles(files) {
            const file = files[0];
            
            // Check if file is an image
            if (!file.type.match('image.*')) {
                alert('Please select an image file');
                return;
            }
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size should be less than 5MB');
                return;
            }
            
            // Display file info
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.remove('hidden');
            
            // Display preview
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                previewContainer.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Form submission
        document.getElementById('upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('gallery-username').value.trim();
            const title = document.getElementById('image-title').value.trim();
            const description = document.getElementById('image-description').value.trim();
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an image to upload');
                return;
            }
            
            const uploadBtn = document.getElementById('upload-btn');
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> UPLOADING...';
            
            try {
                // Upload to ImgBB
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error('Failed to upload image to ImgBB');
                }
                
                // Get the image URL and thumbnail URL
                const imageUrl = result.data.url;
                const thumbnailUrl = result.data.thumb.url;
                
                // Save to Firestore
                const docRef = await db.collection('gallery').add({
                    username: username,
                    title: title || 'Untitled Creation',
                    description: description || '',
                    imageUrl: imageUrl,
                    thumbnailUrl: thumbnailUrl,
                    likes: 0,
                    likedBy: [],
                    comments: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Reset form
                this.reset();
                fileInfo.classList.add('hidden');
                previewContainer.classList.add('hidden');
                
                // Show success message
                alert('Your creation has been uploaded successfully!');
                
                // Reload gallery
                loadGallery();
            } catch (error) {
                console.error('Error uploading:', error);
                alert('There was an error uploading your image. Please try again.');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i> UPLOAD CREATION';
            }
        });
        
        // Load gallery images
        async function loadGallery() {
            const galleryGrid = document.getElementById('gallery-grid');
            galleryGrid.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-4xl text-green-500"></i><p class="mt-4">Loading creations...</p></div>';
            
            try {
                const snapshot = await db.collection('gallery')
                    .orderBy('createdAt', 'desc')
                    .limit(12)
                    .get();
                
                if (snapshot.empty) {
                    galleryGrid.innerHTML = '<div class="text-center py-8 col-span-full"><i class="fas fa-image text-4xl text-gray-500"></i><p class="mt-4">No creations yet. Be the first to upload!</p></div>';
                    return;
                }
                
                galleryGrid.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.createdAt ? data.createdAt.toDate() : new Date();
                    
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'grid-item gallery-card rounded-lg overflow-hidden cursor-pointer';
                    galleryItem.innerHTML = `
                        <div class="relative group">
                            <img class="w-full h-64 object-cover" src="${data.thumbnailUrl}" alt="${data.title}" loading="lazy">
                            <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                <i class="fas fa-search text-2xl text-white"></i>
                            </div>
                        </div>
                        <div class="p-4">
                            <h3 class="font-semibold truncate">${data.title}</h3>
                            <p class="text-sm text-green-400">@${data.username}</p>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-gray-500">${formatDate(date)}</span>
                                <div class="flex space-x-3">
                                    <span class="text-xs text-gray-400 flex items-center">
                                        <i class="far fa-heart mr-1"></i> ${data.likes || 0}
                                    </span>
                                    <span class="text-xs text-gray-400 flex items-center">
                                        <i class="far fa-comment mr-1"></i> ${data.comments ? data.comments.length : 0}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    galleryItem.addEventListener('click', () => {
                        openImageModal(doc.id, data.imageUrl, data.title, data.username, data.description, date, data.likes || 0, data.comments || []);
                    });
                    
                    galleryGrid.appendChild(galleryItem);
                });
                
                // Show load more button if we have exactly 12 items (meaning there might be more)
                if (snapshot.size === 12) {
                    document.getElementById('load-more-container').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading gallery:', error);
                galleryGrid.innerHTML = '<div class="text-center py-8 col-span-full"><i class="fas fa-exclamation-triangle text-4xl text-red-500"></i><p class="mt-4">Error loading gallery. Please refresh the page.</p></div>';
            }
        }
        
        // Format date
        function formatDate(date) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString(undefined, options);
        }
        
        // Load more images
        let lastVisible = null;
        document.getElementById('load-more-btn').addEventListener('click', async function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> LOADING...';
            
            try {
                let query = db.collection('gallery')
                    .orderBy('createdAt', 'desc')
                    .limit(12);
                
                if (lastVisible) {
                    query = query.startAfter(lastVisible);
                }
                
                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    document.getElementById('load-more-container').classList.add('hidden');
                    return;
                }
                
                lastVisible = snapshot.docs[snapshot.docs.length - 1];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.createdAt ? data.createdAt.toDate() : new Date();
                    
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'grid-item gallery-card rounded-lg overflow-hidden cursor-pointer';
                    galleryItem.innerHTML = `
                        <div class="relative group">
                            <img class="w-full h-64 object-cover" src="${data.thumbnailUrl}" alt="${data.title}" loading="lazy">
                            <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                <i class="fas fa-search text-2xl text-white"></i>
                            </div>
                        </div>
                        <div class="p-4">
                            <h3 class="font-semibold truncate">${data.title}</h3>
                            <p class="text-sm text-green-400">@${data.username}</p>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-gray-500">${formatDate(date)}</span>
                                <div class="flex space-x-3">
                                    <span class="text-xs text-gray-400 flex items-center">
                                        <i class="far fa-heart mr-1"></i> ${data.likes || 0}
                                    </span>
                                    <span class="text-xs text-gray-400 flex items-center">
                                        <i class="far fa-comment mr-1"></i> ${data.comments ? data.comments.length : 0}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    galleryItem.addEventListener('click', () => {
                        openImageModal(doc.id, data.imageUrl, data.title, data.username, data.description, date, data.likes || 0, data.comments || []);
                    });
                    
                    document.getElementById('gallery-grid').appendChild(galleryItem);
                });
                
                // Hide load more button if we got less than 12 items
                if (snapshot.size < 12) {
                    document.getElementById('load-more-container').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading more:', error);
                alert('Error loading more images. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus mr-2"></i> LOAD MORE';
            }
        });
        
        // Image modal functionality
        function openImageModal(id, imageUrl, title, username, description, date, likes, comments) {
            currentImageId = id;
            
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            const modalTitle = document.getElementById('modal-title');
            const modalUsername = document.getElementById('modal-username');
            const modalDescription = document.getElementById('modal-description');
            const modalDate = document.getElementById('modal-date');
            const likeCount = document.getElementById('like-count');
            const commentCount = document.getElementById('comment-count');
            const likeBtn = document.getElementById('like-btn');
            
            modalImage.src = imageUrl;
            modalTitle.textContent = title;
            modalUsername.textContent = `by @${username}`;
            modalDescription.textContent = description || 'No description provided';
            modalDate.textContent = `Uploaded on ${date.toLocaleDateString()} at ${date.toLocaleTimeString()}`;
            likeCount.textContent = likes;
            commentCount.textContent = comments.length;
            
            // Reset like button state
            if (likedImages[id]) {
                likeBtn.classList.add('liked');
                likeBtn.innerHTML = '<i class="fas fa-heart text-xl"></i>';
            } else {
                likeBtn.classList.remove('liked');
                likeBtn.innerHTML = '<i class="far fa-heart text-xl"></i>';
            }
            
            // Hide comment section by default
            document.getElementById('comment-section').classList.add('hidden');
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Load comments
            loadComments(comments);
        }
        
        // Load comments into modal
        function loadComments(comments) {
            const commentSection = document.getElementById('comment-section').querySelector('.comment-section');
            
            if (comments.length === 0) {
                commentSection.innerHTML = '<p class="text-center text-gray-500 py-4">No comments yet. Be the first to comment!</p>';
                return;
            }
            
            commentSection.innerHTML = '';
            
            // Sort comments by date (newest first)
            comments.sort((a, b) => b.timestamp - a.timestamp);
            
            comments.forEach(comment => {
                const commentDate = new Date(comment.timestamp);
                
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item p-3 mb-3';
                commentItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-semibold text-green-400">@${comment.username}</p>
                            <p class="text-sm mt-1">${comment.text}</p>
                        </div>
                        <div class="flex space-x-2">
                            <span class="text-xs text-gray-500">${formatDate(commentDate)}</span>
                            <button class="reply-btn text-xs text-blue-400 hover:text-blue-300" data-comment-id="${comment.id}">
                                <i class="fas fa-reply mr-1"></i>Reply
                            </button>
                        </div>
                    </div>
                    <div id="replies-${comment.id}" class="mt-2"></div>
                `;
                
                commentSection.appendChild(commentItem);
                
                // Load replies if any
                if (comment.replies && comment.replies.length > 0) {
                    const repliesContainer = document.getElementById(`replies-${comment.id}`);
                    
                    comment.replies.forEach(reply => {
                        const replyDate = new Date(reply.timestamp);
                        
                        const replyItem = document.createElement('div');
                        replyItem.className = 'reply-item p-3 mb-2';
                        replyItem.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-semibold text-blue-400">@${reply.username}</p>
                                    <p class="text-xs mt-1">${reply.text}</p>
                                </div>
                                <span class="text-xs text-gray-500">${formatDate(replyDate)}</span>
                            </div>
                        `;
                        
                        repliesContainer.appendChild(replyItem);
                    });
                }
            });
            
            // Add event listeners for reply buttons
            document.querySelectorAll('.reply-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const commentId = this.getAttribute('data-comment-id');
                    document.getElementById('parent-comment-id').value = commentId;
                    document.getElementById('cancel-reply').classList.remove('hidden');
                    
                    // Scroll to comment form
                    document.getElementById('comment-form-container').scrollIntoView({ behavior: 'smooth' });
                });
            });
        }
        
        // Cancel reply
        document.getElementById('cancel-reply').addEventListener('click', function() {
            document.getElementById('parent-comment-id').value = '';
            this.classList.add('hidden');
        });
        
        // Like button functionality
        document.getElementById('like-btn').addEventListener('click', function() {
            if (likedImages[currentImageId]) {
                // Unlike the image
                unlikeImage();
            } else {
                // Show username modal for like
                document.getElementById('username-modal').classList.remove('hidden');
            }
        });
        
        // Cancel like
        document.getElementById('cancel-like').addEventListener('click', function() {
            document.getElementById('username-modal').classList.add('hidden');
        });
        
        // Confirm like
        document.getElementById('confirm-like').addEventListener('click', async function() {
            const username = document.getElementById('like-username').value.trim();
            
            if (!username) {
                alert('Please enter your Minecraft username');
                return;
            }
            
            currentUsername = username;
            document.getElementById('username-modal').classList.add('hidden');
            
            // Like the image
            await likeImage();
        });
        
        // Like an image
        async function likeImage() {
            if (!currentImageId || !currentUsername) return;
            
            try {
                const imageRef = db.collection('gallery').doc(currentImageId);
                
                // Check if user already liked this image
                const doc = await imageRef.get();
                const data = doc.data();
                
                if (data.likedBy && data.likedBy.includes(currentUsername)) {
                    alert('You have already liked this image!');
                    return;
                }
                
                // Update likes count and add user to likedBy array
                await imageRef.update({
                    likes: firebase.firestore.FieldValue.increment(1),
                    likedBy: firebase.firestore.FieldValue.arrayUnion(currentUsername)
                });
                
                // Update UI
                document.getElementById('like-btn').classList.add('liked');
                document.getElementById('like-btn').innerHTML = '<i class="fas fa-heart text-xl"></i>';
                
                const likeCount = document.getElementById('like-count');
                likeCount.textContent = parseInt(likeCount.textContent) + 1;
                
                // Store in localStorage
                likedImages[currentImageId] = true;
                localStorage.setItem('likedImages', JSON.stringify(likedImages));
                
                // Show success message
                alert('Thanks for your like!');
            } catch (error) {
                console.error('Error liking image:', error);
                alert('There was an error processing your like. Please try again.');
            }
        }
        
        // Unlike an image
        async function unlikeImage() {
            if (!currentImageId || !currentUsername) return;
            
            try {
                const imageRef = db.collection('gallery').doc(currentImageId);
                
                // Update likes count and remove user from likedBy array
                await imageRef.update({
                    likes: firebase.firestore.FieldValue.increment(-1),
                    likedBy: firebase.firestore.FieldValue.arrayRemove(currentUsername)
                });
                
                // Update UI
                document.getElementById('like-btn').classList.remove('liked');
                document.getElementById('like-btn').innerHTML = '<i class="far fa-heart text-xl"></i>';
                
                const likeCount = document.getElementById('like-count');
                likeCount.textContent = parseInt(likeCount.textContent) - 1;
                
                // Remove from localStorage
                delete likedImages[currentImageId];
                localStorage.setItem('likedImages', JSON.stringify(likedImages));
                
                // Show success message
                alert('You unliked this image.');
            } catch (error) {
                console.error('Error unliking image:', error);
                alert('There was an error processing your unlike. Please try again.');
            }
        }
        
        // Comment button functionality
        document.getElementById('comment-btn').addEventListener('click', function() {
            const commentSection = document.getElementById('comment-section');
            commentSection.classList.toggle('hidden');
            
            if (!commentSection.classList.contains('hidden')) {
                // Scroll to comment section
                commentSection.scrollIntoView({ behavior: 'smooth' });
            }
        });
        
        // Comment form submission
        document.getElementById('comment-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('comment-username').value.trim();
            const text = document.getElementById('comment-text').value.trim();
            const parentCommentId = document.getElementById('parent-comment-id').value;
            
            if (!username || !text) {
                alert('Please enter both username and comment text');
                return;
            }
            
            const btn = this.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> POSTING...';
            
            try {
                const imageRef = db.collection('gallery').doc(currentImageId);
                const commentData = {
                    id: Date.now().toString(),
                    username: username,
                    text: text,
                    timestamp: Date.now(),
                    replies: []
                };
                
                if (parentCommentId) {
                    // This is a reply to an existing comment
                    await imageRef.update({
                        comments: firebase.firestore.FieldValue.arrayUnion({
                            id: parentCommentId,
                            replies: [{
                                id: Date.now().toString(),
                                username: username,
                                text: text,
                                timestamp: Date.now()
                            }]
                        })
                    });
                    
                    // Reset reply form
                    document.getElementById('parent-comment-id').value = '';
                    document.getElementById('cancel-reply').classList.add('hidden');
                } else {
                    // This is a new top-level comment
                    await imageRef.update({
                        comments: firebase.firestore.FieldValue.arrayUnion(commentData)
                    });
                }
                
                // Reset form
                this.reset();
                
                // Reload comments to show the new one
                const doc = await imageRef.get();
                const data = doc.data();
                loadComments(data.comments || []);
                
                // Update comment count
                document.getElementById('comment-count').textContent = data.comments.length;
                
                // Show success message
                alert('Comment posted successfully!');
            } catch (error) {
                console.error('Error posting comment:', error);
                alert('There was an error posting your comment. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane mr-1"></i> POST COMMENT';
            }
        });
        
        // Close modal
        document.getElementById('close-modal').addEventListener('click', function() {
            document.getElementById('image-modal').classList.add('hidden');
            document.getElementById('comment-section').classList.add('hidden');
            document.body.style.overflow = 'auto';
        });
        
        // Close modal when clicking outside
        document.getElementById('image-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
                document.getElementById('comment-section').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
        });
        
        // Close modal with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.getElementById('image-modal').classList.add('hidden');
                document.getElementById('comment-section').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
        });
        
        // Close username modal with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && !document.getElementById('username-modal').classList.contains('hidden')) {
                document.getElementById('username-modal').classList.add('hidden');
            }
        });
        
        // Initialize the page
        window.addEventListener('DOMContentLoaded', () => {
            loadGallery();
        });
    </script>
</body>
</html>