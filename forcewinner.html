<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATRIX MC | Force Winner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: sans-serif;
        }
        
        .card {
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
        }
        
        .btn-primary {
            background-color: #22c55e;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            background-color: #16a34a;
        }
        
        .btn-danger {
            background-color: #ef4444;
            transition: all 0.2s ease;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-success {
            background-color: #22c55e;
            transition: all 0.2s ease;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .winner-radio {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            outline: none;
            cursor: pointer;
            margin-right: 8px;
            position: relative;
            vertical-align: middle;
        }
        
        .winner-radio:checked::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 10px;
            height: 10px;
            background-color: #3b82f6;
            border-radius: 50%;
        }
        
        .winner-row {
            transition: background-color 0.2s ease;
        }
        
        .winner-row:hover {
            background-color: #334155;
        }
        
        .winner-row.selected {
            background-color: #1e3a8a;
        }
    </style>
</head>
<body class="min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-green-500">MATRIX MC - Force Winner</h1>
            <button id="logout-btn" class="px-4 py-2 bg-red-600 rounded-lg hover:bg-red-700">
                <i class="fas fa-sign-out-alt mr-2"></i> Logout
            </button>
        </div>
        
        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-bold mb-6">Select Date</h2>
            <div class="flex items-center space-x-4">
                <input type="date" id="winner-date-select" class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="load-voters-btn" class="btn-primary px-4 py-2 rounded-lg">
                    <span id="load-voters-text">Load Voters</span>
                    <span id="load-voters-spinner" class="spinner hidden"></span>
                </button>
            </div>
            <p id="index-help-text" class="text-sm text-gray-400 mt-2 hidden">
                First time loading? You might need to <a id="create-index-link" href="#" class="text-blue-400 hover:underline">create a database index</a>.
            </p>
        </div>
        
        <div class="card p-6 mb-8 hidden" id="voters-list-container">
            <h3 class="text-xl font-semibold mb-4">Voters for <span id="selected-date-display"></span></h3>
            <div class="mb-4">
                <p class="text-gray-400 mb-2">Total voters: <span id="total-voters-count">0</span></p>
                <p class="text-gray-400">Select one voter as winner:</p>
            </div>
            <div class="overflow-x-auto max-h-96 overflow-y-auto">
                <table class="w-full">
                    <thead class="sticky top-0 bg-gray-800">
                        <tr class="text-left border-b border-gray-700">
                            <th class="pb-2"></th>
                            <th class="pb-2">Username</th>
                            <th class="pb-2">Time</th>
                        </tr>
                    </thead>
                    <tbody id="voters-list-table">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-between items-center">
                <div>
                    <button id="select-random-winner-btn" class="btn-primary px-4 py-2 rounded-lg mr-2">
                        <i class="fas fa-random mr-2"></i>
                        <span id="select-winner-text">Select Random Winner</span>
                        <span id="select-winner-spinner" class="spinner hidden"></span>
                    </button>
                    <button id="clear-selection-btn" class="btn-danger px-4 py-2 rounded-lg">
                        <i class="fas fa-times mr-2"></i>
                        Clear Selection
                    </button>
                </div>
                <button id="confirm-selected-winner-btn" class="btn-success px-4 py-2 rounded-lg hidden">
                    <i class="fas fa-check mr-2"></i>
                    <span id="confirm-winner-text">Confirm Selected Winner</span>
                    <span id="confirm-winner-spinner" class="spinner hidden"></span>
                </button>
            </div>
        </div>
        
        <div class="card p-6 hidden" id="winner-confirmation-container">
            <h3 class="text-xl font-semibold mb-4">Confirm Winner</h3>
            <div class="mb-4">
                <p class="text-xl">Selected winner: <span class="font-bold text-blue-400" id="selected-winner-name"></span></p>
                <p class="text-gray-400">For date: <span id="winner-date-display"></span></p>
            </div>
            <div class="flex space-x-4">
                <button id="confirm-winner-btn" class="btn-success px-4 py-2 rounded-lg">
                    <i class="fas fa-check mr-2"></i>
                    <span id="confirm-final-winner-text">Confirm & Notify Discord</span>
                    <span id="confirm-final-winner-spinner" class="spinner hidden"></span>
                </button>
                <button id="cancel-winner-btn" class="btn-danger px-4 py-2 rounded-lg">
                    <i class="fas fa-times mr-2"></i>
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4 border border-green-500">
            <div class="text-center">
                <i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i>
                <h3 class="text-xl font-bold mb-2 text-white" id="success-modal-title">Success!</h3>
                <p class="text-gray-300 mb-6" id="success-modal-message">Operation completed successfully.</p>
                <button id="close-success-modal" class="btn-primary px-6 py-2 rounded-lg font-semibold">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4 border border-blue-500">
            <div class="text-center">
                <i class="fas fa-exclamation-circle text-blue-500 text-5xl mb-4"></i>
                <h3 class="text-xl font-bold mb-2 text-white" id="confirmation-modal-title">Confirm Action</h3>
                <p class="text-gray-300 mb-6" id="confirmation-modal-message">Are you sure you want to perform this action?</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-action-btn" class="btn-primary px-6 py-2 rounded-lg font-semibold">Confirm</button>
                    <button id="cancel-action-btn" class="btn-danger px-6 py-2 rounded-lg font-semibold">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
    apiKey: "AIzaSyDj6TSp7nvuLqvQ6CLqJQTxJFHIwHHbtNE",
    authDomain: "matrix-ed062.firebaseapp.com",
    projectId: "matrix-ed062",
    storageBucket: "matrix-ed062.firebasestorage.app",
    messagingSenderId: "82407502701",
    appId: "1:82407502701:web:c1af23c4606c2fcbd86064",
    measurementId: "G-02680ERGSV"
  };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // DOM Elements
        const winnerDateSelect = document.getElementById('winner-date-select');
        const loadVotersBtn = document.getElementById('load-voters-btn');
        const loadVotersText = document.getElementById('load-voters-text');
        const loadVotersSpinner = document.getElementById('load-voters-spinner');
        const votersListContainer = document.getElementById('voters-list-container');
        const selectedDateDisplay = document.getElementById('selected-date-display');
        const totalVotersCount = document.getElementById('total-voters-count');
        const votersListTable = document.getElementById('voters-list-table');
        const selectRandomWinnerBtn = document.getElementById('select-random-winner-btn');
        const selectWinnerText = document.getElementById('select-winner-text');
        const selectWinnerSpinner = document.getElementById('select-winner-spinner');
        const clearSelectionBtn = document.getElementById('clear-selection-btn');
        const confirmSelectedWinnerBtn = document.getElementById('confirm-selected-winner-btn');
        const winnerConfirmationContainer = document.getElementById('winner-confirmation-container');
        const selectedWinnerName = document.getElementById('selected-winner-name');
        const winnerDateDisplay = document.getElementById('winner-date-display');
        const confirmWinnerBtn = document.getElementById('confirm-winner-btn');
        const confirmFinalWinnerText = document.getElementById('confirm-final-winner-text');
        const confirmFinalWinnerSpinner = document.getElementById('confirm-final-winner-spinner');
        const cancelWinnerBtn = document.getElementById('cancel-winner-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const indexHelpText = document.getElementById('index-help-text');
        const createIndexLink = document.getElementById('create-index-link');
        
        // Modals
        const successModal = document.getElementById('success-modal');
        const successModalTitle = document.getElementById('success-modal-title');
        const successModalMessage = document.getElementById('success-modal-message');
        const closeSuccessModal = document.getElementById('close-success-modal');
        
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationModalTitle = document.getElementById('confirmation-modal-title');
        const confirmationModalMessage = document.getElementById('confirmation-modal-message');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const cancelActionBtn = document.getElementById('cancel-action-btn');
        
        // Global variables
        let currentUser = null;
        let selectedVoters = [];
        let selectedWinner = null;
        let selectedWinnerDate = '';
        let webhookSettings = {};
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date as default
            const today = new Date();
            winnerDateSelect.valueAsDate = today;
            
            // Check authentication
            checkAuth();
            
            // Set up event listeners
            setupEventListeners();
            
            // Load webhook settings
            loadWebhookSettings();
            
            // Set up index creation link
            createIndexLink.href = `https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore/indexes`;
            createIndexLink.target = "_blank";
        });
        
        function checkAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    console.log("User is signed in:", user.email);
                } else {
                    window.location.href = "login.html";
                }
            });
        }
        
        function setupEventListeners() {
            // Force winner section
            loadVotersBtn.addEventListener('click', loadVotersForDate);
            selectRandomWinnerBtn.addEventListener('click', selectRandomWinner);
            clearSelectionBtn.addEventListener('click', clearSelection);
            confirmSelectedWinnerBtn.addEventListener('click', confirmSelectedWinner);
            confirmWinnerBtn.addEventListener('click', confirmWinner);
            cancelWinnerBtn.addEventListener('click', cancelWinnerSelection);
            
            // Logout button
            logoutBtn.addEventListener('click', function() {
                auth.signOut().then(() => {
                    window.location.href = "login.html";
                });
            });
            
            // Modals
            closeSuccessModal.addEventListener('click', () => {
                successModal.classList.add('hidden');
            });
            
            cancelActionBtn.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
            });
        }
        
        async function loadVotersForDate() {
            const selectedDate = winnerDateSelect.value;
            if (!selectedDate) {
                showError("Please select a date first");
                return;
            }
            
            loadVotersText.textContent = "Loading...";
            loadVotersSpinner.classList.remove('hidden');
            loadVotersBtn.disabled = true;
            clearSelection();
            indexHelpText.classList.add('hidden');
            
            try {
                // Try the optimized query first (with composite index)
                let votesSnapshot;
                try {
                    votesSnapshot = await db.collection('votes')
                        .where('date', '==', selectedDate)
                        .orderBy('timestamp', 'asc')
                        .get();
                } catch (indexError) {
                    if (indexError.code === 'failed-precondition') {
                        // Fallback to client-side sorting if index doesn't exist
                        console.warn("Composite index missing, falling back to client-side sorting");
                        indexHelpText.classList.remove('hidden');
                        
                        const unsortedSnapshot = await db.collection('votes')
                            .where('date', '==', selectedDate)
                            .get();
                            
                        // Convert to array and sort client-side
                        const votes = [];
                        unsortedSnapshot.forEach(doc => {
                            votes.push(doc.data());
                        });
                        
                        // Sort by timestamp
                        votes.sort((a, b) => {
                            if (a.timestamp && b.timestamp) {
                                return a.timestamp.toDate() - b.timestamp.toDate();
                            }
                            return 0;
                        });
                        
                        selectedVoters = votes;
                        renderVotersList();
                        votersListContainer.classList.remove('hidden');
                        return;
                    }
                    throw indexError;
                }
                
                selectedVoters = [];
                votesSnapshot.forEach(doc => {
                    selectedVoters.push(doc.data());
                });
                
                // Update UI
                selectedDateDisplay.textContent = selectedDate;
                totalVotersCount.textContent = selectedVoters.length;
                
                renderVotersList();
                
                votersListContainer.classList.remove('hidden');
                
            } catch (error) {
                console.error("Error loading voters:", error);
                
                if (error.code === 'failed-precondition') {
                    showError("Database index missing. Click the link below to create it.");
                    indexHelpText.classList.remove('hidden');
                } else {
                    showError("Failed to load voters. Please try again.");
                }
            } finally {
                loadVotersText.textContent = "Load Voters";
                loadVotersSpinner.classList.add('hidden');
                loadVotersBtn.disabled = false;
            }
        }
        
        function renderVotersList() {
            votersListTable.innerHTML = '';
            
            if (selectedVoters.length === 0) {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700';
                row.innerHTML = `
                    <td colspan="3" class="py-4 text-center text-gray-500">No voters found for this date</td>
                `;
                votersListTable.appendChild(row);
            } else {
                selectedVoters.forEach(voter => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700 winner-row';
                    row.innerHTML = `
                        <td class="py-3">
                            <input type="radio" name="winner" class="winner-radio" value="${voter.username}">
                        </td>
                        <td class="py-3">${voter.username}</td>
                        <td class="py-3">${formatTime(voter.timestamp?.toDate())}</td>
                    `;
                    votersListTable.appendChild(row);
                });
                
                // Add event listeners to radio buttons
                document.querySelectorAll('.winner-radio').forEach(radio => {
                    radio.addEventListener('change', function() {
                        handleWinnerSelection(this);
                    });
                });
            }
        }
        
        function handleWinnerSelection(radio) {
            // Remove selected class from all rows
            document.querySelectorAll('.winner-row').forEach(row => {
                row.classList.remove('selected');
            });
            
            // Add selected class to the selected row
            if (radio.checked) {
                const row = radio.closest('tr');
                if (row) {
                    row.classList.add('selected');
                    selectedWinner = radio.value;
                    confirmSelectedWinnerBtn.classList.remove('hidden');
                }
            } else {
                confirmSelectedWinnerBtn.classList.add('hidden');
            }
        }
        
        function selectRandomWinner() {
            if (selectedVoters.length === 0) {
                showError("No voters available to select from");
                return;
            }
            
            clearSelection();
            
            const randomIndex = Math.floor(Math.random() * selectedVoters.length);
            selectedWinner = selectedVoters[randomIndex].username;
            
            // Find and check the radio button for the selected winner
            const radioButtons = document.querySelectorAll('.winner-radio');
            radioButtons.forEach(radio => {
                if (radio.value === selectedWinner) {
                    radio.checked = true;
                    const row = radio.closest('tr');
                    if (row) {
                        row.classList.add('selected');
                    }
                }
            });
            
            confirmSelectedWinnerBtn.classList.remove('hidden');
        }
        
        function clearSelection() {
            // Uncheck all radio buttons
            document.querySelectorAll('.winner-radio').forEach(radio => {
                radio.checked = false;
            });
            
            // Remove selected class from all rows
            document.querySelectorAll('.winner-row').forEach(row => {
                row.classList.remove('selected');
            });
            
            // Hide confirm button
            confirmSelectedWinnerBtn.classList.add('hidden');
            
            // Clear selected winner
            selectedWinner = null;
        }
        
        function confirmSelectedWinner() {
            if (!selectedWinner) {
                showError("No winner selected");
                return;
            }
            
            selectedWinnerDate = selectedDateDisplay.textContent;
            
            // Show confirmation container
            selectedWinnerName.textContent = selectedWinner;
            winnerDateDisplay.textContent = selectedWinnerDate;
            winnerConfirmationContainer.classList.remove('hidden');
        }
        
        async function confirmWinner() {
            confirmFinalWinnerText.textContent = "Processing...";
            confirmFinalWinnerSpinner.classList.remove('hidden');
            confirmWinnerBtn.disabled = true;
            
            try {
                // Check if winner already exists for this date
                const existingWinner = await db.collection('winners')
                    .where('date', '==', selectedWinnerDate)
                    .get();
                
                if (!existingWinner.empty) {
                    showError("A winner already exists for this date");
                    return;
                }
                
                // Save winner to Firestore
                await db.collection('winners').add({
                    username: selectedWinner,
                    date: selectedWinnerDate,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    isForced: true
                });
                
                // Send Discord notification if webhook is configured
                if (webhookSettings.url) {
                    await sendDiscordWinnerNotification(selectedWinner, selectedWinnerDate);
                }
                
                // Reset UI
                winnerConfirmationContainer.classList.add('hidden');
                votersListContainer.classList.add('hidden');
                clearSelection();
                
                showSuccess("Winner selected and notified successfully");
                
            } catch (error) {
                console.error("Error confirming winner:", error);
                showError("Failed to confirm winner");
            } finally {
                confirmFinalWinnerText.textContent = "Confirm & Notify Discord";
                confirmFinalWinnerSpinner.classList.add('hidden');
                confirmWinnerBtn.disabled = false;
            }
        }
        
        function cancelWinnerSelection() {
            winnerConfirmationContainer.classList.add('hidden');
        }
        
        async function sendDiscordWinnerNotification(winner, date) {
            try {
                const response = await fetch(webhookSettings.url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        embeds: [{
                            title: "🎉 Daily Vote Winner 🎉",
                            description: `Congratulations to **${winner}** for being the winner for ${date}!\n\nKeep voting daily for a chance to win!`,
                            color: 0xffd700, // Gold color
                            footer: {
                                text: "Matrix MC Voting System"
                            },
                            timestamp: new Date().toISOString()
                        }]
                    })
                });
                
                if (!response.ok) {
                    console.error("Discord webhook error:", response.statusText);
                }
            } catch (error) {
                console.error("Error sending Discord notification:", error);
            }
        }
        
        async function loadWebhookSettings() {
            try {
                // Load webhook settings
                const webhookDoc = await db.collection('settings').doc('webhook').get();
                if (webhookDoc.exists) {
                    webhookSettings = webhookDoc.data();
                }
            } catch (error) {
                console.error("Error loading webhook settings:", error);
            }
        }
        
        function showSuccess(message) {
            successModalTitle.textContent = "Success!";
            successModalMessage.textContent = message;
            successModal.classList.remove('hidden');
        }
        
        function showError(message) {
            successModalTitle.textContent = "Error!";
            successModalMessage.textContent = message;
            successModal.classList.remove('hidden');
        }
        
        // Helper function
        function formatTime(date) {
            if (!date) return 'N/A';
            return date.toLocaleTimeString();
        }
    </script>
</body>
</html>